sudo: true
env:
  global:
    - AWS_ACCESS_KEY_ID=AKIAIYAXFUAHXOWP2MJA
    # AWS_SECRET_ACCESS_KEY
    - secure: vgLWzyUtbmHzQKYM4pGjW5pI9ABICJVnqSf0VPx9sXmWCAqsqA69T5YPs3cmPcm1Lypv6o/vwRRkwhhwfcZb0feaq8nMNGYFv7erfvBInnZ0YM3DXUAm8PmpKmN/TVavMYd8qEfARxRqx6PIj3zwT58X5S/p+vwjTheiQGPKBZosFmQMwNqhvOIpA7xugBXIgQdYOhBhZD2g1xMHRyYBcBwVrAI0fEsqo43t64poDlKWGXfYYi1q3L112QR2eb4zMbH/n0L5x+BMHKh7uJDn0pSOZBx78L2zLPfol4s61yRMZY0TICEk2sUPI8D/FgPhj1Et3m4Wm9bMvY7BBsEqJosTnJN5z9RwHTtGp1E+zhWOslU4gAJ+SGYk+yJEpMIgWykU1TK5kcHG3x2SGz9E4Z/Ah3RvBtZOLXpoavDim48lsVxy8IyfiXVPBP+wyPuyjEGUJjgR5H33ScfOctLxZs0BLc2HIPT3QbO7mdZPH78e9ys1CwfA7ly3ypm5e5EHQ8dIB9deuiqvMqCLS+r3ifkfdVAqNGi/lCiXP0dr+WzFO4EuKXm36cySlCSwreyqgOml+odf+qNGalxggeO2h1fcKzaMKLNElPNFhzJjYdaShPLi0BPMarwsa4vIAf0VKY+gJpQC/DYd9r7pEHELmfyCbEtzonJMAF3NrCCEdpk=
jobs:
  include:
    - stage: Tests
      name: Unit Tests
      if:
        type = pull_request OR type = push AND branch =~ /^master|[0-9]+-(dev|stable)$/
        OR type = cron
      language: node_js
      node_js: 10
      before_install:
        - sudo sysctl -w vm.max_map_count=262144
        - sudo sysctl -w fs.inotify.max_user_watches=524288
      script:
        - npm install --unsafe-perm && npm test
    - stage: Tests
      name: Dead link check
      language: node_js
      node_js: 10
      if:
        type = pull_request OR type = push AND branch =~ /^master|[0-9]+-(dev|stable)$/
        OR type = cron
      before_script:
        - npm ci --production=false
        - npm i --save-dev kuzdoc
        - npm run doc-prepare
        - "$(npm bin)/kuzdoc iterate-repos:install --repos_path doc/framework/.repos/"
        - "$(npm bin)/kuzdoc framework:link -d /official-plugins/s3/1/ -v 1"
      script:
        - gem install typhoeus
        - cd doc/framework/ && HYDRA_MAX_CONCURRENCY=20 ruby .ci/dead-links.rb -p src/official-plugins/s3/1/
    - stage: Deployment Doc Dev
      name: Deploy next-docs.kuzzle.io
      if: type = push AND branch =~ .*-dev
      language: node_js
      node_js: 10
      env:
        - BRANCH=dev
        - NODE_ENV=production
        - S3_BUCKET=docs-next.kuzzle.io
        - CLOUDFRONT_DISTRIBUTION_ID=E2ZCCEK9GRB49U
        - AWS_DEFAULT_REGION=us-west-2
      addons:
        apt:
          packages:
            - python
            - python-pip
      install:
        - pip install awscli --upgrade --user
        - npm ci --production=false
        - npm i --save-dev kuzdoc
      script:
        - npm run doc-prepare
        - npm run doc-build
      deploy:
        provider: script
        script:
          - npm run doc-upload
        skip_cleanup: true
        on:
          all_branches: true
      after_deploy:
        - npm run doc-cloudfront
    - stage: Deployment Doc Prod
      name: Deploy docs.kuzzle.io
      if: type = push AND branch =~ /^master|[0-9]+-stable$/
      language: node_js
      node_js: 10
      env:
        - NODE_ENV=production
        - S3_BUCKET=docs.kuzzle.io
        - CLOUDFRONT_DISTRIBUTION_ID=E3D6RP0POLCJMM
        - AWS_DEFAULT_REGION=us-west-2
      addons:
        apt:
          packages:
            - python
            - python-pip
      install:
        - pip install awscli --upgrade --user
        - npm ci --production=false
        - npm i --save-dev kuzdoc
      script:
        - npm run doc-prepare
        - npm run doc-build
      deploy:
        provider: script
        script:
          - npm run doc-upload
        skip_cleanup: true
        on:
          all_branches: true
      after_deploy:
        - npm run doc-cloudfront
